<!DOCTYPE html>
<html>
<head>

<script src=""></script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.1.2/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.16.1/vis.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.16.1/vis.min.css"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.8/es5-shim.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/es6-shim/0.35.1/es6-shim.min.js"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-77691127-4', 'auto');
  ga('send', 'pageview');

</script>

<script>

// Global vars

var quartets = {}; // dictionary
var singers = {}; // dictionary

// Read the CSV file and build a network graph model
Papa.parse("https://raw.githubusercontent.com/liwenyip/6-degrees-of-nooj/gh-pages/BABS%20Quartet%20Singers.csv", {
 download: true,
 complete: function(results) {
  // compile unique lists of quartets, singers, and relationships
  $.each(results.data, function(i, row) {
    q = row[0];
    s = row[1];
    // create the quartet and singer if they don't exist
    if (!quartets.hasOwnProperty(q)) quartets[q] = {name:q, type:"q", links:[]};
    if (!singers.hasOwnProperty(s))  singers[s]  = {name:s, type:"s", links:[]};
    // create links between quartet and singer (but don't create duplicates)
    if ($.inArray(singers[s], quartets[q].links) == -1) quartets[q].links.push(singers[s]);
    if ($.inArray(quartets[q], singers[s].links) == -1) singers[s].links.push(quartets[q]);
  });
  // Set autocomplete on inputs
  $( "#from, #to" ).autocomplete({
    source: Object.keys(singers)
  });
  // debug
  console.log(quartets);
  console.log(singers);
 }
});

function getLabel(node) {
  label = node.name;
  if (node.type == "s") label += " (" + node.distance + ")";
  return label;
}

function getGroup(node, toNode, fromNode) {
  if (node == toNode) return "To";
  if (node == fromNode) return "From";
  return node.type;
}

// Make a graph
$(function() {
  $( "#go" ).click(function() {
    // create the new graph
    console.log("Creating graph object...");
    graphLinks = new vis.DataSet([]);
    graphNodes = new vis.DataSet([]);
    var container = document.getElementById('network');
    var data = {
      nodes: graphNodes,
      edges: graphLinks
    };
    var options = {};
    var network = new vis.Network(container, data, options);
    
    // Traverse the graph model
    console.log("Traversing model...");
    // initialise root node
    fromNode = singers[$("#from").val()];
    fromNode.distance = 0;
    // initialise Nooj
    toNode = singers[$("#to").val()];
    toNode.distance = -1;
    // initialise lists
    toVisit = [fromNode];  // queue of nodes to be visited
    visited = [] // list of nodes that have been visited
    visitedLinks = [] // list of links, use for graphing web
    // create a network, starting with the selected Singer
    // Do a breadth-first search from the root node
    while (toVisit.length > 0) {
      // get the next node to visit, mark it as visited
      node = toVisit.shift()
      visited.push(node);
      // loop through linked nodes
      $.each(node.links, function(i, node2) {
        if ($.inArray(node2, visited) != -1) return true; // skip linked nodes we've already visited
        if ($.inArray(node2, toVisit) != -1) return true; // skip linked nodes we've already checked
        visitedLinks.push({from:node.name, to:node2.name}); // add link (edge) to the graph
        toVisit.push(node2); // add linked node to list to visit
        node2.distance = node.distance + 0.5;
      });
    }
    
    // Check if we reached the target and calculate shortest path
    console.log("Calculating shortest path...");
    msg = "<p>";
    if (toNode.distance == -1) msg += fromNode.name + " is not connected to " + toNode.name;
    else {
      // calculate distance
      if (toNode.name == "Nooj") {
        msg += fromNode.name + " has a Nooj number of " + toNode.distance + ": ";
      } else {
        msg += fromNode.name + " is connected to " + toNode.name + " by " + toNode.distance + " quartets:"
      }
      // find shortest single path
      next = toNode;
      path = [toNode];
      while (path[0] != fromNode) {
        $.each(path[0].links, function(j, link) {
          if (link.distance < next.distance) next = link;
        });
        path.unshift(next);
      }      
      msg += "</p><p>" + path.map(getLabel).join(' -> ') + "</p>";
    }
    $("#result").html(msg);
    
    // Make some pretty graphs
    if ( $("#graphtype").val() == "paths") {
      // find and graph shortest multiple paths
      console.log("Graphing paths...");
      paths = [toNode];
      i = 0;
      while (paths[i] != fromNode && i < paths.length) {
        $.each(paths[i].links, function(j, link) {
          if (link.distance < paths[i].distance) {
            graphLinks.add({from:paths[i].name, to:link.name});
            if ($.inArray(link, paths) == -1) {
              paths.push(link);
            }
          }
        });
        i++;
      }
      $.each(paths, function(i, node) {
        graphNodes.add({id:node.name, label:getLabel(node), group:getGroup(node, toNode, fromNode), level:node.distance});
      });
    } else {
      // graph a web of lies
      console.log("Graphing web...");
      network.setData({edges:visitedLinks, nodes:graphNodes});
      $.each(visited, function(i, node) {
        graphNodes.add({id:node.name, label:getLabel(node), group:getGroup(node, toNode, fromNode), level:node.distance});
        if (i > 100) return false;
      });
    }
    // Do the visualisation stuff
    console.log("Done.");
  });
});

</script>

  <style type="text/css">
    #network {
      width: 100%;
      height: 600px;
      border: 1px solid lightgray;
    }
  </style>

</head>
<body>

<h2>Six Degrees of Nooj</h2>

<div class="ui-widget">
  <label for="from">From: </label>
  <input id="from">
  <label for="to">To: </label>
  <input id="to" value="Nooj">
  <label for="graphtype">Show me: </label>
  <select id="graphtype">
    <option value="paths">Paths between them</option>
    <option value="web">Web around the first person</option>
  </select>
  <button id="go">Go!</button>
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="about.html">About</a>
  
</div>
<div id="result"><p>&nbsp;</p></div>
<div id="network"></div>

</body>
</html>
